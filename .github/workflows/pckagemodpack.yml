name: Package OptiArk and Create Release

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag name'
        required: true
        default: 'optiark-v1.0.0'
        type: string
      release_name:
        description: 'Release name'
        required: true
        default: 'OptiArk Packages'
        type: string
      version_filter:
        description: 'Version filter patterns (e.g., "1.21.4,1.21.7" or "1.20" or leave empty for all)'
        required: false
        default: ''
        type: string
      filter_mode:
        description: 'Filter mode'
        required: false
        default: 'include'
        type: choice
        options:
        - include
        - exclude
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean

jobs:
  package-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Create packages directory
      run: mkdir -p packages
    
    - name: Find and package minecraft folders
      run: |
        echo "üîç Scanning for OptiArk directories..."
        
        # Parse version filter
        version_filter="${{ github.event.inputs.version_filter }}"
        filter_mode="${{ github.event.inputs.filter_mode }}"
        echo "üìã Version filter: '$version_filter'"
        echo "üéØ Filter mode: $filter_mode"
        
        # Function to check if directory matches filter
        matches_filter() {
          local dir_name="$1"
          local filter="$2"
          local mode="$3"
          
          # If no filter specified, include everything
          if [ -z "$filter" ]; then
            return 0
          fi
          
          # Convert comma-separated filters to array
          IFS=',' read -ra FILTERS <<< "$filter"
          
          local pattern_matched=false
          for pattern in "${FILTERS[@]}"; do
            # Trim whitespace
            pattern=$(echo "$pattern" | xargs)
            
            # Check if directory name contains this pattern
            if [[ "$dir_name" == *"$pattern"* ]]; then
              pattern_matched=true
              break
            fi
          done
          
          # Apply include/exclude logic
          if [ "$mode" = "include" ]; then
            if [ "$pattern_matched" = true ]; then
              echo "‚úÖ '$dir_name' matches INCLUDE filter"
              return 0
            else
              echo "‚ùå '$dir_name' does not match INCLUDE filter"
              return 1
            fi
          else  # exclude mode
            if [ "$pattern_matched" = true ]; then
              echo "‚ùå '$dir_name' matches EXCLUDE filter - skipping"
              return 1
            else
              echo "‚úÖ '$dir_name' does not match EXCLUDE filter - including"
              return 0
            fi
          fi
        }
        
        # Find all directories that match the OptiArk pattern
        found_packages=0
        skipped_packages=0
        for dir in OptiArk.*; do
          if [ -d "$dir" ]; then
            echo "üìÅ Processing directory: $dir"
            
            # Check if this directory matches our version filter
            if ! matches_filter "$dir" "$version_filter" "$filter_mode"; then
              echo "‚è≠Ô∏è  Skipping $dir (filter: $filter_mode)"
              skipped_packages=$((skipped_packages + 1))
              continue
            fi
            
            # Check if minecraft folder exists in this directory
            if [ -d "$dir/minecraft" ]; then
              echo "‚úÖ Found minecraft folder in $dir"
              
              # Create zip file named after the parent directory
              cd "$dir"
              
              # Add minecraft folder to zip
              zip -r "../packages/${dir}.zip" minecraft/
              
              # Add instance.cfg if it exists
              if [ -f "instance.cfg" ]; then
                echo "‚úÖ Adding instance.cfg to ${dir}.zip"
                zip -u "../packages/${dir}.zip" instance.cfg
              else
                echo "‚ö†Ô∏è  No instance.cfg found in $dir"
              fi
              
              # Add mmc-pack.json if it exists
              if [ -f "mmc-pack.json" ]; then
                echo "‚úÖ Adding mmc-pack.json to ${dir}.zip"
                zip -u "../packages/${dir}.zip" mmc-pack.json
              else
                echo "‚ö†Ô∏è  No mmc-pack.json found in $dir"
              fi
              
              cd ..
              
              # Verify the zip was created
              if [ -f "packages/${dir}.zip" ]; then
                size=$(stat -f%z "packages/${dir}.zip" 2>/dev/null || stat -c%s "packages/${dir}.zip" 2>/dev/null || echo "0")
                size_mb=$((size / 1024 / 1024))
                echo "‚úÖ Created ${dir}.zip (${size_mb}MB)"
                found_packages=$((found_packages + 1))
              else
                echo "‚ùå Failed to create ${dir}.zip"
              fi
            else
              echo "‚ö†Ô∏è  No minecraft folder found in $dir"
              skipped_packages=$((skipped_packages + 1))
            fi
          fi
        done
        
        echo ""
        echo "üì¶ Total packages created: $found_packages"
        echo "‚è≠Ô∏è  Total packages skipped: $skipped_packages"
        
        if [ $found_packages -eq 0 ]; then
          echo "‚ùå No packages were created!"
          if [ -n "$version_filter" ]; then
            echo "üí° Try adjusting your version filter: '$filter_mode $version_filter'"
            echo "üí° Available directories:"
            ls -1d OptiArk.* 2>/dev/null || echo "   No OptiArk directories found"
          else
            echo "üí° Make sure you have OptiArk.* directories with minecraft folders."
          fi
          exit 1
        fi
    
    - name: Generate release notes
      run: |
        echo "# OptiArk Packages - Release ${{ github.event.inputs.release_tag }}" > release_notes.md
        echo "" >> release_notes.md
        echo "üéÆ **OptiArk minecraft folder packages ready for download!**" >> release_notes.md
        echo "" >> release_notes.md
        echo "Generated on: $(date)" >> release_notes.md
        echo "Commit: [\`${GITHUB_SHA:0:7}\`](https://github.com/arc360alt/OptiArk/commit/$GITHUB_SHA)" >> release_notes.md
        
        # Add filter info if used
        version_filter="${{ github.event.inputs.version_filter }}"
        filter_mode="${{ github.event.inputs.filter_mode }}"
        if [ -n "$version_filter" ]; then
          echo "Filter: \`$filter_mode\` patterns \`$version_filter\`" >> release_notes.md
        fi
        
        echo "" >> release_notes.md
        echo "## üì¶ Available Packages:" >> release_notes.md
        echo "" >> release_notes.md
        
        total_size=0
        package_count=0
        for zip_file in packages/*.zip; do
          if [ -f "$zip_file" ]; then
            filename=$(basename "$zip_file")
            size=$(stat -f%z "$zip_file" 2>/dev/null || stat -c%s "$zip_file" 2>/dev/null || echo "0")
            size_mb=$((size / 1024 / 1024))
            total_size=$((total_size + size))
            package_count=$((package_count + 1))
            
            # Extract version info from filename
            version=$(echo "$filename" | sed 's/OptiArk\.//' | sed 's/\.zip//')
            echo "| \`$filename\` | $version | ${size_mb}MB |" >> release_notes.md
          fi
        done
        
        # Add table header
        sed -i '7i| Package | Version | Size |' release_notes.md
        sed -i '8i|---------|---------|------|' release_notes.md
        
        total_mb=$((total_size / 1024 / 1024))
        echo "" >> release_notes.md
        echo "**üìä Summary:**" >> release_notes.md
        echo "- Total packages: **$package_count**" >> release_notes.md
        echo "- Total size: **${total_mb}MB**" >> release_notes.md
        echo "" >> release_notes.md
        echo "## üöÄ Installation:" >> release_notes.md
        echo "1. Download the package for your desired OptiArk version" >> release_notes.md
        echo "2. Extract the zip file" >> release_notes.md
        echo "3. Use the minecraft folder contents, instance.cfg, and mmc-pack.json as needed" >> release_notes.md
        echo "" >> release_notes.md
        echo "---" >> release_notes.md
        echo "*Each package contains the minecraft folder, instance.cfg, and mmc-pack.json (if available) from the corresponding OptiArk version.*" >> release_notes.md
        
        echo "üìã Release notes preview:"
        cat release_notes.md
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.event.inputs.release_tag }}
        name: ${{ github.event.inputs.release_name }}
        body_path: release_notes.md
        files: packages/*.zip
        draft: false
        prerelease: ${{ github.event.inputs.prerelease }}
        make_latest: true
        token: ${{ secrets.PAT_TOKEN }}
    
    - name: Upload packages as backup artifacts
      uses: actions/upload-artifact@v4
      with:
        name: optiark-packages-backup-${{ github.run_number }}
        path: packages/
        retention-days: 7
        compression-level: 0
    
    - name: Success summary
      run: |
        echo "## üéâ OptiArk Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üìã Release Details:" >> $GITHUB_STEP_SUMMARY
        echo "- **Tag:** \`${{ github.event.inputs.release_tag }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Name:** ${{ github.event.inputs.release_name }}" >> $GITHUB_STEP_SUMMARY
        if [ "${{ github.event.inputs.prerelease }}" = "true" ]; then
          echo "- **Type:** Pre-release" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Type:** Stable release" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### üì¶ Packaged Files:" >> $GITHUB_STEP_SUMMARY
        total_size=0
        for zip_file in packages/*.zip; do
          if [ -f "$zip_file" ]; then
            filename=$(basename "$zip_file")
            size=$(stat -f%z "$zip_file" 2>/dev/null || stat -c%s "$zip_file" 2>/dev/null || echo "0")
            size_mb=$((size / 1024 / 1024))
            total_size=$((total_size + size))
            echo "- ‚úÖ \`$filename\` (${size_mb}MB)" >> $GITHUB_STEP_SUMMARY
          fi
        done
        
        total_mb=$((total_size / 1024 / 1024))
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Total:** ${total_mb}MB across $(ls packages/*.zip | wc -l) packages" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üîó Links:" >> $GITHUB_STEP_SUMMARY
        echo "- üéØ **[View Release](https://github.com/arc360alt/OptiArk/releases/tag/${{ github.event.inputs.release_tag }})**" >> $GITHUB_STEP_SUMMARY
        echo "- üì• **[All Releases](https://github.com/arc360alt/OptiArk/releases)**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "üéÆ **Your OptiArk packages are now ready for download!**" >> $GITHUB_STEP_SUMMARY
