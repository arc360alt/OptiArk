name: Package OptiArk Minecraft Folders

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag name'
        required: true
        default: 'optiark-packages-v1.0.0'
        type: string
      release_name:
        description: 'Release name'
        required: true
        default: 'OptiArk Minecraft Packages'
        type: string

jobs:
  package-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Create packages directory
      run: mkdir -p packages
    
    - name: Find and package minecraft folders
      run: |
        # Find all directories that match the OptiArk pattern
        for dir in OptiArk.*; do
          if [ -d "$dir" ]; then
            echo "Processing directory: $dir"
            
            # Check if minecraft folder exists in this directory
            if [ -d "$dir/minecraft" ]; then
              echo "Found minecraft folder in $dir"
              
              # Create zip file named after the parent directory
              cd "$dir"
              zip -r "../packages/${dir}.zip" minecraft/
              cd ..
              
              echo "Created ${dir}.zip"
            else
              echo "No minecraft folder found in $dir"
            fi
          fi
        done
    
    - name: List created packages
      run: |
        echo "Created packages:"
        ls -la packages/
    
    - name: Check if packages were created
      run: |
        if [ -z "$(ls -A packages/)" ]; then
          echo "No packages were created. Exiting."
          exit 1
        fi
    
    - name: Create Release with Assets
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Create release notes
        echo "## OptiArk Minecraft Packages" > release_notes.md
        echo "" >> release_notes.md
        echo "This release contains packaged minecraft folders from various OptiArk versions." >> release_notes.md
        echo "" >> release_notes.md
        echo "Each zip file is named after its source OptiArk directory and contains the minecraft folder from that version." >> release_notes.md
        echo "" >> release_notes.md
        echo "**Available packages:**" >> release_notes.md
        for zip_file in packages/*.zip; do
          if [ -f "$zip_file" ]; then
            filename=$(basename "$zip_file")
            echo "- $filename" >> release_notes.md
          fi
        done
        echo "" >> release_notes.md
        echo "Download the package for your desired OptiArk version." >> release_notes.md
        
        # Create release with all zip files
        gh release create "${{ github.event.inputs.release_tag }}" \
          --title "${{ github.event.inputs.release_name }}" \
          --notes-file release_notes.md \
          packages/*.zip
    
    - name: Summary
      run: |
        echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
        echo "Successfully created release: ${{ github.event.inputs.release_name }}" >> $GITHUB_STEP_SUMMARY
        echo "Release tag: ${{ github.event.inputs.release_tag }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Packaged Files:" >> $GITHUB_STEP_SUMMARY
        for zip_file in packages/*.zip; do
          if [ -f "$zip_file" ]; then
            filename=$(basename "$zip_file")
            size=$(du -h "$zip_file" | cut -f1)
            echo "- $filename ($size)" >> $GITHUB_STEP_SUMMARY
          fi
        done
